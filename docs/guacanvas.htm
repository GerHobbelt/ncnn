<html><body>
<style>
canvas {
margin:20px;
-webkit-transform: matrix(1.2,0,0,1.2,0,0);
}

</style></body><script>
var lv=6;
var bitbuf = new Uint8Array(32);

var hflv=lv>>1;


var canv_alpha=document.createElement('canvas');
var ctx_alpha=canv_alpha.getContext('2d');
document.body.appendChild(canv_alpha);

var canv=document.createElement('canvas');
var ctx=canv.getContext('2d');
document.body.appendChild(canv);

function mkimgpool()
{
	imgpool=document.createElement('div');
	document.body.appendChild(imgpool);
}

mkimgpool();



canv.width = 20;
var prvcvh=lv*20+20;
canv.height = prvcvh;

function getrev(v)
{
	var rev=0;
	for(var i=0;i<lv;i++)
	{
		var rty=lv-1-i;
		if((v>>i)&1 == 1)
		{
			rev+=1<<rty;
			bitbuf[rty]=1;
		} else {bitbuf[rty]=0;}
	}
	return rev
}


function mkbrush(na)
{
	var img=document.createElement('img');
	img.src=na;
	return img;
}

imggrd=mkbrush('bxbs0_8.png');
imggrdb=mkbrush('bxbs0_8b.png');
numbs=mkbrush('num2.png');
yaobs=mkbrush('yao2.png');


hflv4shi_notload=true;

var cirkdata=[[1,93,103,59,  110,205,8,171,   137,076,239,42,  127,69,25,35],
[2,157,70,191,174,206,140,138,  155,4,223,38,   55,87,21,19],
[3,63,71,29,  46,139,12,207,  237, 72,169,106,   89,101,123,33],
[5,95,39,27,   78,141,10,175,   235,40,201,108,  57,99,125,65]];


var shinames=new Array(8);
shinames[3]=['0@', '1@', '绁O活', '2@', '5@', '绀C活', '4@', '3@'];
shinames[4]=[
'O@',	'绁@',	'GO活','G@',
'|O活','きO活','せO活','T@',
'C@','せ┎活','き┎活','|┎活',
'せ@',	'G┎活','き@',	'|@'
];

function odd2upmiddown()
{

}

function even2upmiddown()
{

}

function even2updown()
{

}

class Gualink {
bsv;
bsv_masa;
child;
idx;
idx_my;
img;


constructor(bv,ydx) {
	this.bsv = bv;
	this.bsv_masa = bv;
	this.idx=-1;
	this.child=new Array(lv);
	this.child.fill(true);
}

setidx(v) {
	if(this.idx<0){this.idx=v;
	Gualink_ordered[v]=this;

	if(this.bsv<0){
		var msta=0;
		var mend=Gualink_mvidx[0];
		var cur_mvmsk=negGualink_mvmsk;
		var cur_mv=negGualink_mv;
		
	} else {
		var msta=Gualink_mvidx[1];
		var mend=hflv;
		var cur_mvmsk=Gualink_mvmsk;
		var cur_mv=Gualink_mv;
	}
	for(var i=msta;i<mend;i++)
	{
		if((v&cur_mvmsk[i])==0)
		{
			this.child[i].setidx(v+cur_mv[i]);
		}
		
	}

}
}

fixidx(v) {
	this.idx=v;
	Gualink_ordered[v]=this;
	
}

getkey(v,disable=false) {

	if(disable){this.child[mvot]=false;}
	var dyz=this.bsv;
	var kybss='(('+dyz+'))_';
	if(dyz<0){
		return kybss+v;
	}
	return kybss+mvot;

}

}

var shidatatype=1;

function getshi(v)
{
	var shidata_low=hflv4shi[v];
	
	var shidata_high=shidata_low>>c_hflv;
	shidata_low&=c_bmsk;
	switch(shidatatype)
	{
		case 0:
		return shinames[hflv][shidata_high]+shidata_low;
		
		case 1:
		return [shidata_high,shidata_low];

		case 2:
		var splitaa=even2updown(shidata_low);
		return [shidata_high,splitaa];
		
		
	}
}





var fontrgb=[[0xff,0,0],[0xff,0,0xff],[0,0,0xff]];

function dra3(v,yoff,xoff,wdiv)
{
	var fystr=v.toFixed(0);
	var zhu=fystr.length;
	var rw=wdiv/zhu;
	for(var i=0;i<zhu;i++)
	{
			var rna=fystr.charCodeAt(i)-0x30;
			ctx_alpha.drawImage(numbs, rna*9, 0, 9, 9, xoff+i*rw, yoff, rw, 12);
	}

}

function dra2(v,yoff,firstshi)
{
	dra3(v,yoff,xoff,16);
	dra3(v,yoff,xoff,27);
}

function clamp4bit(v)
{
	return (((v-1)>>2)+1)<<2;
}

function is111(v)
{
	if(((v+1)&v)==0){return true;}
	return false;
}


function shistrxor(y,x)
{
	var shisig=y^x;
	
	var tal=x;
	if(shisig<hfhflvrg){
		
		if(is111(shisig)){tal=y;}
	} else {
		var tal=(~tal)&bmsk;
	}
	return (shisig<<c_hflv)	+tal	;

}

function setupcbmsk()
{
	hfhflvrg=1<<(hflv-1);
	bmsk=(1<<hflv)-1;
	c_hflv=clamp4bit(hflv);
	if( c_hflv == hflv )
	{
		c_bmsk=(1<<c_hflv)-1;
	} else {
		c_bmsk=bmsk;
	}
	
}

function uintsqarr()
{
	allrg=1<<(hflv<<1);
	if(hflv<5){
		return new Uint8Array(allrg);
	} else if(hflv<9){
		return new Uint16Array(allrg);
	}
	return new Uint32Array(allrg);
	
}

function uintsqarr_withp(level)
{
	allrg=1<<(level);
	sqrg=1<<(level-1);
	if(level<9){
		return new Uint8Array(sqrg);
	} else if(level<17){
		return new Uint16Array(sqrg);
	}
	return new Uint32Array(sqrg);
	
}

function gen_shi()
{
	setupcbmsk();
	
	var hfrg=1<<hflv;
	

	var ret=uintsqarr();

	for(var y0=0;y0<hfrg;y0++) {
		var y0a=y0<<hflv;
		for(var x0=0;x0<hfrg;x0++) {
			ret[y0a+x0]=shistrxor(y0,x0);
		}
	}
	return ret;

}

function setupshi1()
{
	if(hflv4shi_notload)
	{
		hflv4shi_notload=false;
		hflv4shi=gen_shi();

	
	}

}

function drawcirk(kirkidx=0)
{
	var shimapw=16;

	var ckdata=cirkdata[kirkidx];
	var cirkl=ckdata.length;
	var cvh=24*cirkl;
	canv_alpha.width = 50;
	canv_alpha.height = cvh;
	ctx_alpha.clearRect(0, 0, 50, cvh);	//w40xh12
	setupshi1();

	canv.width = 320;
	canv.height = 320;
	ctx.clearRect(0, 0, 320, 320);

	var firstshi=getshi(ckdata[0])[0];
	//canv_ctx.globalCompositeOperation ='destination-in';
	var revarr=new Array(cirkl);
	var shinum=new Array(cirkl);
	var imgd = canv_alpha.getImageData(0, 0, 50, cvh);
	var bdata=imgd.data;
	for(var cc=0;cc<cirkl;cc++)
	{
		var v=ckdata[cc];
		dra2(v,cc*24,firstshi);
		
	
	}
	

}

function drawtxt(v,pos,xsft=1)
{
	var fystr=v.toFixed(0);
	var zhu=fystr.length;
	var fysta=0;
	if(zhu>3){fysta=zhu-3;zhu=3;}
	var rw=18/zhu;
	
	if(pos == 0)
	{
		for(var i=0;i<zhu;i++)
		{
			var rna=fystr.charCodeAt(fysta+i)-0x30;
			ctx.drawImage(numbs, rna*9, 0, 9, 9, xsft+i*rw, 0, rw, 9);
		}
		if(fysta>0)
		{
			xsft+=1;
			var ysft=bsta+2;
			for(var i=0;i<fysta;i++)
			{
				var rna=fystr.charCodeAt(i)-0x30;
				ctx.drawImage(numbs, rna*9, 0, 9, 9, xsft+i*4, ysft, 4, 6);
			}
		}
	} else {
		
		var zhu2=zhu+fysta-1;
		for(var i=0;i<zhu;i++)
		{
			var rna=fystr.charCodeAt(zhu2-i)-0x30;
			ctx.drawImage(numbs, rna*9, 9, 9, 9, xsft+i*rw, pos, rw, 9);
		}

		if(fysta>0)
		{
			var ysft=pos-9;
			xsft+=13;
			for(var i=0;i<fysta;i++)
			{
				var rna=fystr.charCodeAt(i)-0x30;
				ctx.drawImage(numbs, rna*9, 9, 9, 9, xsft-i*4, ysft, 4, 6);
			}
		}

	}
	return fystr;
}

function sepimg0(parr,uur,sig=0)
{
	var img=document.createElement('img');
	img.src=uur;
	parr.appendChild(img);
}

function sepimg_log(parr,uur,sig=0)
{
	var img=document.createElement('img');
	img.src=uur;
	parr.appendChild(img);
	parr.sig=sig;
	var krr=Gualink_pool[sig];
	krr.img=parr;
	Gualink_pool[krr.bsv_masa]=krr;
}

var sepimg=sepimg0;


function blobCallback(iconName,sig=0) {
  return (b) => {
    const a = document.createElement('a');

    document.body.appendChild(a);

    a.download = iconName+'.png';
	var uur = window.URL.createObjectURL(b);
	a.href=uur;
	sepimg(a,uur,sig);
  }
}



var bsta=10;

function ismgsqUpper(v)
{
	var x=mgsq_lut[v];
	var y=x>>hflv;
	x=x&bmsk;
	if(x>=y){return true;}
	return false;
}

function drawmgsqUpper(y,v)
{
	if(ismgsqUpper(v)){ctx.drawImage(numbs, 0, 18, 5, 5, 8,y, 5, 5);}
}

function putblak(poz){ctx.drawImage(imggrdb, 1, 1+bsta+poz*20, 18, 18);}

function putwhite(poz){ctx.drawImage(imggrd, 0, bsta+poz*20, 20, 20);}

function mv1to0(v,idx)
{
	var ccmsk=lvmax^(1<<idx);
	return v&ccmsk;
}

function mv0to1(v,idx)
{
	return v|(1<<idx);
}

var lnk_kole=new Set();
var lnk_kole_done=new Set();
var Gualink_pool = new Object();
var txtinfo=[];

function addtolog0(neg,v,cuobs,idxbs){return;}

function addtolog_log(neg,v,cuobs,idxbs)
{
	var loggedv=neg*v;
	lnk_kole.add(loggedv);	
	cur_Gualink.child[idxbs]=mkGualink(loggedv);
}

var addtolog= addtolog0;

function yao_move(cuo,yao_idx,isblak,neg)
{
	if(yao_idx<hflv)
	{
		var mvidx=yao_idx+hflv;
		if(((cuo>>mvidx)&1)==isblak){addtolog(neg,cuo,cuo,yao_idx);	return;}
		if(isblak==1){var cuomod=mv0to1(cuo,mvidx);
		} else { var cuomod=mv1to0(cuo,mvidx);}

		
		if((((lvmax-cuomod)>>yao_idx)&1)==1)
		{
			addtolog(neg,mv0to1(cuomod,yao_idx),cuo,yao_idx);	return;
		}
		addtolog(neg,mv1to0(cuomod,yao_idx),cuo,yao_idx);	return;
		
		
	}
	return;

}

function mkGualink(v)
{
	if(v in Gualink_pool)
	{
		var nyy=Gualink_pool[v];
	}  else  {
		var nyy=new Gualink(v);
		Gualink_pool[v]=nyy;
	}
	return nyy;
}

function draw(v)
{
	var orig_v=v;
	lnk_kole.add(v);
	lnk_kole_done.add(v);
	cur_Gualink=mkGualink(v);
	
	var cvh=lv*20+20;
	if(cvh != prvcvh)
	{
		canv.width = 20;
		canv.height = cvh;
		prvcvh=cvh;
	}


	ctx.clearRect(0, 0, 20, cvh);
	cvh-=bsta;
	
	var rev=0;
	if(v<0){
		var cur_v=-v;
		rev=cur_v;
		v=0;
		var cuo=lvmax-cur_v;
		for(var i=0;i<lv;i++)
		{
			var rty=lv-1-i;
			putwhite(i);
			var is1=0;
			if((cur_v&1)==1){
				is1=1;
				putblak(i);
				v+=1<<rty;
				}
			yao_move(cuo,i,is1,1);
			cur_v>>=1;
		}
		cur_Gualink.bsv_masa=v;
		
	} else {
		var cur_v=v;
		var cuo=lvmax-cur_v;
		for(var i=0;i<lv;i++)
		{
			var rty=lv-1-i;
			putwhite(rty);
			var is1=0;
			if((cur_v&1)==1){
				is1=1;
				putblak(rty);
				rev+=1<<rty;
				}
			yao_move(cuo,i,is1,-1);
			cur_v>>=1;
			
		}
	}
	
	var msna=drawtxt(v,0);
	drawmgsqUpper(bsta+7,v);
	if (rev!=v){
		msna+='_'+drawtxt(rev,cvh+1);
		drawmgsqUpper(cvh-12,rev);
	}
	
	canv.toBlob(blobCallback(msna,orig_v),'image/png');

}

var Gualink_mv=[];
var Gualink_mvmsk=[];
var negGualink_mv=[];
var negGualink_mvmsk=[];

function mkgmvmsk(idx,dyst,prepmsk=-1)
{
	Gualink_mv[idx]=dyst;
	negGualink_mv[hflv-idx-1]=dyst;
	var pmsk=prepmsk;
	
	if(pmsk<0){
		pmsk=dyst-1;
		if(pmsk<1){pmsk=1;}
	};
	
	Gualink_mvmsk[idx]=pmsk;
	negGualink_mvmsk[hflv-idx-1]=pmsk;
}

const Gualink_mvxtralen=4;

function Gualink_walk()
{
	var lvx2=lv<<1;
	Gualink_mv=new Uint16Array(lvx2+Gualink_mvxtralen);
	Gualink_mv.fill(0xffff);
	Gualink_mvidx=Gualink_mv.subarray(lvx2, lvx2+Gualink_mvxtralen);
	Gualink_mvmsk=Gualink_mv.subarray(hflv, lv);
	negGualink_mv=Gualink_mv.subarray(lv, lv+hflv);
	negGualink_mvmsk=Gualink_mv.subarray(lv+hflv, lvx2);
	Gualink_mv=Gualink_mv.subarray(0, hflv);
	
	var qv=hflv>>1;
	

	if(is_hflvodd)
	{
		Gualink_mvidx[0]=qv+1;	//0 to x
		Gualink_mvidx[1]=qv;	//x to hflv
		mkgmvmsk(qv,1);
		qv++;
		var dyst=2;
		
		
	} else {
		Gualink_mvidx[0]=qv;
		Gualink_mvidx[1]=qv;
		mkgmvmsk(qv,1,0);
		qv++;
		var dyst=4;
	}
	mkgmvmsk(qv,dyst);
	dyst<<=2;
	qv++;
	
	for(var i=qv;i<hflv;i++)
	{
		mkgmvmsk(i,dyst);
		dyst<<=1;
	}
	return;

}

function draw_linked_sepline()
{
	var img=document.createElement('img');
	img.src='sepline.png';
	img.width=8;
	img.height=prvcvh+30;
	imgpool.appendChild(img);
}




function refine()
{
var tlen=1<<((hflv&0xfe)-2);
var gapsft=2;
if(is_hflvodd){gapsft=3;}

if(tlen>linked_count){tlen=linked_count;}

for(var rx=0;rx<tlen;rx++)
{
	if((((rx)^(rx>>2))&1)!=0){
		refine_swap(rx<<gapsft);
	}
}
arlnk();
}

function refine2(seq)
{
	var sqrg=1<<hflv;
	Gualink_ordered=new Array(sqrg);
	var sql=seq.length;
	for(var i=0;i<sql;i++)
	{
		var krr=Gualink_pool[seq[i]];
		krr.idx_my=i;
		Gualink_ordered[i]=krr;
	}
	arlnk();
}

function refine_swap(fixidx)
{
	if(is_hflvodd)
	{
		var cfixidx=fixidx+2;
		for(var i=0;i<2;i++)
		{
			
			var adoi=cfixidx+4;
			var tmp=Gualink_ordered[cfixidx];
			var fxdst=Gualink_ordered[adoi];
			fxdst.fixidx(cfixidx);
			tmp.fixidx(adoi);
			cfixidx++;
		}
		return;
	}
	fixidx+=1;
	var adoi=fixidx+2;
	var tmp=Gualink_ordered[fixidx];
	var fxdst=Gualink_ordered[adoi];
	fxdst.fixidx(fixidx);
	tmp.fixidx(adoi);
}

/*

const fixmtx=[
0,1,0,1,
1,0,1,0,
0,1,0,1,
1,0,1,0];
const fixmr45=[[1],[3]];	//w=16
const fixmr67=[[0,1],[0,3],	[1,0],[1,2],	[2,1],[2,3],	[3,0],[3,2]];

//	refine(fixmr45)

function refine_bak(fixmr=fixmr67)
{
	var dpth=hflv-2;
	var sqrg=1<<dpth;
	var fixmrl=fixmr.length;
	for(var i=0;i<fixmrl;i++)
	{
		var tofix=fixmr[i]
		var fixidx=(tofix[0]<<dpth);
		var dpt=dpth-2;
		var dl=tofix.length;
		for(var d=1;d<dl;d++)
		{
			if(dpt<=0){break;}
			fixidx+=tofix[d]<<dpt;
			dpt-=2;
		}
		refine_swap(fixidx);
	}

	arlnk();
	
}
*/

function arlnk()
{
	var origpool=imgpool;
	mkimgpool();
	
	var sqrg=1<<(hflv-2);
	for(var y=0;y<4;y++)
	{
		draw_linked_sepline();
		var y0a=y*sqrg;
		for(var x=0;x<sqrg;x++)
		{
			var vv=Gualink_ordered[y0a+x];
			if(vv!== undefined){imgpool.appendChild(vv.img);}
		}
		
	}
	draw_linked_sepline();
	origpool.remove();

}

function draw_linked_af1()
{
	var sqrg=1<<hflv;
	Gualink_ordered=new Array(sqrg);

	Gualink_pool[	Gualink_mvidx[2]	].setidx(0);
	draw_linked_sepline();
	sqrg>>=2;
	linked_count=0;
	for(var y=0;y<4;y++)
	{
		var y0a=y*sqrg;
		for(var x=0;x<sqrg;x++)
		{
			var vv=Gualink_ordered[y0a+x];
			if(vv!== undefined){
			imgpool.appendChild(vv.img);
			var xpsta=hflv-1;
			for(var txtp=xpsta;txtp>=0;txtp--)
			{
				mvot=hflv+txtp;
				if(vv.child[mvot])
				{
					var dst=vv.child[txtp];
					txtinfo.push(vv.getkey(txtp)+ztab+dst.getkey(txtp,true));
				}
			}
			vv.idx=linked_count;
			Gualink_ordered[linked_count]=vv;
			linked_count++;

			}
		}
		draw_linked_sepline();
	}
	txtinfo=txtinfo.join('\n');
	
}

function draw_linked_glob()
{
	lnk_kole=new Set();
	lnk_kole_done=new Set();
	txtinfo=[];
	Gualink_pool = new Object();
	addtolog = addtolog_log;
	sepimg = sepimg_log;
	Gualink_walk();
	Gualink_ordered=null;

}

function draw_linked(v)
{

	draw_linked_glob();

	Gualink_mvidx[2]=v;
	draw(v);
	var itr=0;
	while(lnk_kole.size!=lnk_kole_done.size)
	{
		
		lnk_kole.forEach(k => {
		if(!lnk_kole_done.has(k)){draw(k);}
		itr++;
		})
		console.log('loop'+itr);
		
		if(itr>lvmax){break;}
	}

	setTimeout(draw_linked_af1, 8<<hflv);
	
	return;
	

}

function setbrush(i)
{
	if(bitbuf[i]==1){ ctx.fillStyle = 'red';
	return true;
	} else { ctx.fillStyle = 'black';
	return false;
	}
}

function vline(sta,vert=true)
{
	if(vert){
		for(var y=0;y<hflv;y++){sqarbuf[y*hflv+sta]+=1;}
		return;
	}
	var yoff=sta*hflv;
	for(var x=0;x<hflv;x++){sqarbuf[yoff+x]+=1;}
	return;

}

function drawsqa(v)
{
	var cvh=hflv*10-8;
	var cvhptitle=cvh+bsta*2;
	if(cvh != prvcvh)
	{
		canv.width = cvhptitle;
		canv.height = cvhptitle;
		prvcvh=cvh;
		topx=cvh+bsta-10;
		botmy=cvh+bsta+1;
		sqarbuf = new Uint8Array(hflv*hflv);
	}
	sqarbuf.fill(0);
	ctx.clearRect(0, 0, cvhptitle, cvhptitle);

	var rev=getrev(v);
	var hflvm1=hflv-1;
	for(var i=0;i<hflv;i++)
	{
		var ofst=bsta+10*i;
		if(setbrush(i)){vline(i,true);}
		ctx.fillRect(ofst, bsta, 2, cvh);	//vert
		
		if(setbrush(hflv+i)){vline(i,false);}
		ctx.fillRect(bsta, ofst, cvh, 2);	//hori
		
	}
	var msna=drawtxt(v,0,topx);
	if (rev!=v){msna+='_'+drawtxt(rev,botmy);}
	canv.toBlob(blobCallback(msna),'image/png');

	var prt=new Array(hflv);
	for(var y=0;y<hflv;y++)
	{
		var sta=hflv*y;
		prt[y]=sqarbuf.subarray(sta,sta+hflv).join('-');
	}
	prt=prt.join('\n');
	console.log(prt);

}


function mkmgsq_even()
{
	var retsq=uintsqarr();
	var lztidx=allrg-1;
	var hfallrg=allrg>>1;
	for(var i=0;i<hfallrg;i++)
	{
		var tztchg=(i^(i>>hflv));
		tztchg = (tztchg^(tztchg>>1))&1;
		
		var rvidx=lztidx-i;
		if(tztchg != 0){
			retsq[i]=rvidx;
			retsq[rvidx]=i;
		} else {
			retsq[i]=i;
			retsq[rvidx]=rvidx;
		}
	}
	mgsq_lut=retsq;
	return retsq;
}

function hfrev(v)
{
	//return v;
	var rev=0;
	var hflvsub1=hflv-1;
	for(var i=0;i<hflv;i++)
	{
		if((v>>i)&1 != 0)
		{
			rev+=1<<(hflvsub1-i);
		} 
	}
	return rev
}

function mkmgsq_even_alt()
{
	mgsq=uintsqarr();
	mgsq_lut=uintsqarr();
	var sqrg=1<<hflv;
	var colz=new Array(sqrg);
	var ylen=sqrg>>1;
	var lztidx=sqrg-1;

	for(var vv=0;vv<ylen;vv++)
	{
		var rvidx=lztidx-vv;
		if(((vv^(vv>>1))&1) != 0){
			colz[vv]=hfrev(rvidx);
			colz[rvidx]=hfrev(vv);
		} else {
			colz[vv]=hfrev(vv);
			colz[rvidx]=hfrev(rvidx);
		}
		
	}
	for(var y=0;y<sqrg;y++)
	{
		var y0a=y<<hflv;
		var gtidx=y;
		var x_rev=false;
		if(((y^(y>>1))&1) != 0){x_rev=true;};

		var upr=colz[gtidx];
		for(var x=y;x<sqrg;x++)
		{
			var cur_upr=upr;
			if(((x^(x>>1))&1)!=0){cur_upr=lztidx-upr;}
			gtidx=x;
			if(x_rev) {gtidx=lztidx-x;}
			var subr=colz[gtidx];
			var ydx=y0a+x;
			var ydv=(cur_upr<<hflv)+subr;
			mgsq[ydx]=ydv
			mgsq_lut[ydv]=ydx;

			ydx=(x<<hflv)+y;
			ydv=(subr<<hflv)+cur_upr;

			mgsq[ydx]=ydv
			mgsq_lut[ydv]=ydx;
		}
	}
	
}


function mkmgsq_odd(level)
{
	
	var retsq0=uintsqarr_withp(level);
	var retsq1=uintsqarr_withp(level);

	var lztidx=allrg-1;
	var hfallrg=allrg>>2;
	var odd_hf=level>>1;
	var i=0;
	
	for(var tk0=0;tk0<2;tk0++)
	{
		for(var tk1=0;tk1<hfallrg;tk1++){
			var tztchg=(i^(i>>odd_hf));
			tztchg = (tztchg^(tztchg>>1))&1;
			var rvidx=lztidx-i;
			if(tztchg == 1){
				retsq0[i]=rvidx;
				retsq0[rvidx-sqrg]=i;
			} else {
				retsq0[i]=i;
				retsq0[rvidx-sqrg]=rvidx;
			}
			i++;}
		var tmp=retsq0;
		retsq0=retsq1;
		retsq1=tmp;
	}
	
	
	return [retsq0,retsq1];

}

function mkmgsq(level)
{
	if((level&1)==1){return mkmgsq_odd(level);}
	hflv=(level>>1);
	return mkmgsq_even();

}

function uintsqarr_wh(wh)
{
	allrg=wh*wh;
	if(wh<17){
		return new Uint8Array(allrg);
	} else if(wh<257){
		return new Uint16Array(allrg);
	}
	return new Uint32Array(allrg);
	
}

function mkmgsq_4x(wh)
{
	var retsq=uintsqarr_wh(wh);
	var lztidx=allrg-1;
	for(var y=0;y<wh;y++)
	{
		var y0a=y*wh;
		for(var x=0;x<wh;x++){
		var i=y0a+x;
		var tztchg=(i^y);
		tztchg = (tztchg^(tztchg>>1))&1;
		
		var rvidx=lztidx-i;
		if(tztchg != 0){
			retsq[i]=rvidx;
			retsq[rvidx]=i;
		} else {
			retsq[i]=i;
			retsq[rvidx]=rvidx;
		}}
	}
	
	
	return retsq;
}

function is2n(v)
{
	var hasdigi=false;
	for(var i=0;i<32;i++)
	{
		if(v==0){return i-1;}
		if((v&1)==1)
		{
			if(hasdigi){return -1;
			} else {hasdigi=true;}
		
		}
		v>>=1;
	}
	return -2;

}

function intsqrt2(v)
{
	for(var i=0;i<32;i++)
	{
		if((v&1)==1){return i>>1;}
		v>>=1;
	}
	return 0;
}

function oddsq_sum(level)
{
	return ((1<<level)-1)<<((level-2)-(level>>1));
}

function setupdeg45(wh,cot=1)
{
	ybs=wh-1;
	xmul=wh<<1;
	r45syd=xmul-1;
	ymul=r45syd-1;
	var ret=new Array(r45syd*r45syd*cot);
	ret.fill(-1);
	return ret;
	
}

function arr_deg45(wh,src,buf,sta_row=0)
{
	var ybs0=ybs;
	if(sta_row!=0){ybs0+=r45syd*sta_row;}

	for(var y=0;y<wh;y++)
	{
		var y0a=y*wh;
		for(var x=0;x<wh;x++)
		{
			buf[ybs0+y*ymul+x*xmul]=src[y0a+x];
		}

	}
	return buf;

}

function txt_deg45arr(src,cot)
{
	var yh=r45syd*cot;
	var rows=new Array(yh);
	for(var y=0;y<yh;y++)
	{
		var y0a=y*r45syd;
		var cols=new Array(r45syd);
		for(var x=0;x<r45syd;x++)
		{
			var v=src[y0a+x];
			if(v<0){cols[x]=' -';
			} else { cols[x]=' '+v; }
		}
		rows[y]=cols.join(' ');
	}
	return rows.join('\n');

}

var deg45gridsft=5; //=32px

function img_deg45arr(src,cot=1)
{
	var gridwh=1<<(deg45gridsft-1);
	var xsftmid=gridwh>>1;
	var canvw=r45syd<<deg45gridsft;
	var canvh=canvw*cot;
	canv.width = canvw;
	canv.height = canvh;
	ctx.clearRect(0, 0, canvw, canvh);
	var yh=r45syd*cot;
	for(var y=0;y<yh;y++)
	{
		var y0a=y*r45syd;
		for(var x=0;x<r45syd;x++)
		{
			var v=src[y0a+x];
			if(v>=0){
				var fystr=v.toFixed(0);
				var zhu=fystr.length;
				var rw=gridwh/zhu;
				var xsft=(x<<deg45gridsft)+xsftmid;
				var ysft=(y<<deg45gridsft)+10;
				for(var i=0;i<zhu;i++)
				{
					var rna=fystr.charCodeAt(i)-0x30;
					ctx.drawImage(numbs, rna*9, 0, 9, 9, xsft+i*rw, ysft, rw, 9);
				}
			}
		}
	}



}

function printsq_deg45(src,print_type=1)
{
	var srg=src.length;
	var wh=Math.sqrt(srg)>>0;
	var rotdeg45=arr_deg45(wh,src,setupdeg45(wh));
	srg=1;

	switch(print_type)
	{
			case 0:
			return rotdeg45;
			case 1:
			return txt_deg45arr(rotdeg45,srg);
			case 2:
			img_deg45arr(rotdeg45,srg);
			return;
	}
}

function printmgsq_deg45(src,print_type=1)
{
	var srg=src.length;

	if(srg<16) {
		var bsft=intsqrt2(src[0].length);
		var wh=1<<bsft;
		var rotdeg45 = setupdeg45(wh,cot=srg);
		for(var kk =0;kk<srg;kk++)
		{
			arr_deg45(wh,src[kk],rotdeg45,sta_row=kk*r45syd);
		}

	} else {
		var bsft=intsqrt2(srg);
		var wh=1<<bsft;
		var rotdeg45=arr_deg45(wh,src,setupdeg45(wh));
		srg=1;
		
	}
	
	switch(print_type)
	{
			case 0:
			return rotdeg45;
			case 1:
			return txt_deg45arr(rotdeg45,srg);
			case 2:
			img_deg45arr(rotdeg45,srg);
			return;
	}

}

function fracstar(arcc=7,bssz=500)
{
	function cirk(rr,x,y)
	{
		ctx.beginPath();
		ctx.arc(x,y, rr, 0, 2 * Math.PI);
		ctx.stroke();
	}
	var angg=Math.PI/arcc;
	var rto=Math.sin(angg)/Math.sin(2*angg);
	prvcvh=(bssz+bssz*(1/(1-rto)))>>1;
	var wh=prvcvh<<1;
	canv.width = wh;
	canv.height = wh;
	var rad=bssz>>1;
	cirk(rad,prvcvh,prvcvh);
	var muv=(Math.cos(2*angg)*rto)+Math.cos(angg);
	var cur_rad=rad;
	var cur_zntry=prvcvh;
	for(var dd=0;dd<arcc;dd++)
	{
		cur_zntry+=muv*cur_rad;
		cur_rad*=rto;
		cirk(cur_rad,prvcvh,cur_zntry);
	}
	
	return 
	
}

var zep0='.';
var zep1='+';

function mgspbit(bitloc)
{
	zep0='0';
	zep1='1';

	var ssq=mgsq;
	var bbmsk=1<<bitloc;
	var srg=ssq.length;
	var rz=new Array(srg);
	rz.fill(zep0);
	for(var i=0;i<srg;i++)
	{
		if((ssq[i]&bbmsk)!=0){rz[i]=zep1;}

	}
	strliz=strliz_none;
	return rz.join('');
	//return printmgsq_by4(rz);

}

function strliz0(v)
{
	return v.toString(10);
}

function strliz0b(v)
{
	return (v+1).toString(10);
}


function strliz1(v)
{
	return v.toString(16);
}

function strliz2(v)
{
	return ((v>>hflv)&bmsk).toString(16)+'.'+(v&bmsk).toString(16);
}

function strliz2f(v)
{
	return ((v/allrg)>>0).toString(16)+'.'+(v%allrg).toString(16);
}

var bqa='ap艨As醐筏';
function strliz3(v)
{
	return bqa.charAt(v);
}

function strliz_none(v){return v;}

var strliz=strliz1;
function printmgsq_by4(src)
{
	var srg=src.length;
	if(srg<16) {
		var ret=new Array(srg);
		for(var i=0;i<srg;i++)
		{
			ret[i]=printmgsq_by4(src[i]);
		}
		return ret.join('----------\n');
	} else {
		var bsft=is2n(srg);
		if(bsft<0){return printmgsq_by4f(src);}
		bsft>>=1;
		var grpby4=1<<(bsft-2);
		var ret=[]
		for(var y0=0;y0<grpby4;y0++)
		{
			var y0a=y0<<2;
			for(var y1=0;y1<4;y1++)
			{
				var y1a=(y0a+y1)<<bsft;
				ret1=[];
				for(var x=0;x<grpby4;x++){
					var ydx=y1a+(x<<2);
					ret1.push(strliz(src[ydx])+' '+strliz(src[ydx+1])+' '+strliz(src[ydx+2])+' '+strliz(src[ydx+3]));

				}
				ret.push(ret1.join(ztab));
			}
			ret.push('');
		}
		return ret.join('\n');

	}
	


}

function printmgsq_by4f(src)
{
	var srg=src.length;
	if(srg<16) {
		var ret=new Array(srg);
		for(var i=0;i<srg;i++)
		{
			ret[i]=printmgsq_by4f(src[i]);
		}
		return ret.join('----------\n');
	} else {
		var wh=Math.sqrt(srg)>>0;
		var grpby4=wh>>2;
		var ret=[]
		for(var y0=0;y0<grpby4;y0++)
		{
			var y0a=y0<<2;
			for(var y1=0;y1<4;y1++)
			{
				var y1a=(y0a+y1)*wh;
				ret1=[];
				for(var x=0;x<grpby4;x++){
					var ydx=y1a+(x<<2);
					ret1.push(strliz(src[ydx])+' '+strliz(src[ydx+1])+' '+strliz(src[ydx+2])+' '+strliz(src[ydx+3]));

				}
				ret.push(ret1.join(ztab));
			}
			ret.push('');
		}
		//if(septxt){return ret;}
		return ret.join('\n');

	}
	
}



function hfbin0and1(v,yoff,xoff,spefunc)
{
	var spe=spefunc(v);
	var spev=spe[0];
	
	for(var uuu=0;uuu<2;uuu++)
	{
	var hf_xoff=xoff+mydofst;
	for(var i=0;i<hflv;i++)
	{
		var src_y=0;
		if(i==spev){src_y=12*spe[1];}
		var cur_yoff=yoff+(hflv-1-i)*12;
		if((v&1)==1){
			bitbuf[i]=1;
			ctx.drawImage(yaobs, 24,src_y,24,12, hf_xoff, cur_yoff, 24, 12);
		} else {
			bitbuf[i]=0;
			ctx.drawImage(yaobs, 0,src_y,24,12, hf_xoff, cur_yoff, 24, 12);
		}
		v>>=1;
	}
	if(yoff==xoff){return;}
	var tmp=yoff;
	yoff=xoff;
	xoff=tmp;
	}

}

function int_sqrtf1(x)
{
	var res=0;
	var addo= 0x8000;   
	for(var i=0;i<16;i++)
	{
		var temp=res | addo;
		var g2=temp*temp;      
		if (x>=g2){res=temp;}
		addo>>=1;
	}
	return res;

}

function int_sqrtf0(n)
{
	var sqrt = 0;
	var shift = 15;
	var sqrt2=0;
	while (shift >= 0)
	{
		sqrt2 = ((sqrt << 1) + (1 << shift)) << shift;
	if (sqrt2 <= n){
		sqrt += (1 << shift);
		n -= sqrt2;
	}
		shift--;
	}
	return sqrt;

}


var xcha=[];

xcha[3]=new Uint8Array([
0,1,2,
1,2,0,
2,0,1]);


var LUXmap=null;


/*
0x,0x,0x,0x,

new Uint8Array([
0x1b,0xb1,0xb1,0xb1,0xb1,			0x9c,			0x4e,0x4e,0x4e,0x4e,0x1b,	
0xd8,	0x1b,0xb1,0xb1,0xb1,		0x9c,			0x4e,0x4e,0x4e,0x1b,	0x72,
0xd8,	0xd8,	0x1b,0xb1,0xb1,	0x9c,		0x4e,0x4e,0x1b,	0x72,	0x27,
0xd8,	0xd8,	0xd8,	0x1b,0xb1,	0x9c,		0x4e,0x1b,	0x72,	0x27,	0x27,
0xd8,	0xd8,	0xd8,	0xd8,	0x1b,0x2d,0x6c,	0x72,	0x27,	0x27,	0x27,
0xe1,	0xe1,	0xe1,	0xe1,	0xe1,0xb1,0xe4,	0xb4,	0xb4,	0xb4,	0xb4,
]);

const LUXmap_height=(1+Math.sqrt(1+(LUXmap.length<<3)))>>2;
const LUXmap_width=(LUXmap_height<<1)-1;



function buildLUXele()
{
	var kole=new Array(9);
	kole[0]=LUXele.subarray(0, 12);
	kole[1]=LUXele.subarray(12, 24);

	var kx=2;
	var ydx=24;
	for(var i=0;i<7;i++)
	{
		kole[kx]=LUXele.subarray(ydx, ydx+4);
		kx++;
		ydx+=4;
	}
	LUXele=kole;

}
buildLUXele();
*/

const ztab='\t';



function testlx(height=-1)
{
	if(cur_lx_size==0){return;}
	if(height<0){height=LUXmap_height;}

	var ret=[];
	for(var y=0;y<LUXmap_width;y++)
	{
		var tuoline=[new Array(height),new Array(height)];
		for(var x=0;x<height;x++)
		{
			var v=LUXmap[x*LUXmap_width+y];
			tuoline[0][x]=((v>>6)&3)+' '+((v>>4)&3);
			tuoline[1][x]=((v>>2)&3)+' '+(v&3);
		}
		ret.push(tuoline[0].join(ztab)+'\n'+tuoline[1].join(ztab));
		ret.push('');
	}
	return ret.join('\n');
}

var cur_lx_size=0;
var LUXele=[
	[0x1b,0x2d,0x6c],
	[0xe1,0xb1,0xe4]
];
function buildlx(n)
{
	
	if(n<=cur_lx_size){return;}
	LUXmap_width=n>>1;
	var qoddn=LUXmap_width>>1;
	LUXmap_height=qoddn+1;
	LUXmap = new Uint8Array(LUXmap_width*LUXmap_height);
	var staidx=qoddn-1;
	var lyn0=staidx*(LUXmap_width+1);
	LUXmap.set(LUXele[0], lyn0);
	lyn0+=LUXmap_width;
	LUXmap.set(LUXele[1], lyn0);
	if(staidx>0)
	{
		lyn0-=staidx;
		var toSouth=3+staidx;
		var wm1=LUXmap_width-1;
		var wp1=LUXmap_width+1;
		var gibidx=LUXmap_width+wm1;
		
		for(var d=0;d<staidx;d++)
		{
			LUXmap[d*LUXmap_width+qoddn]=0x9c;	//west
			var fynlin=lyn0+d;
			LUXmap[fynlin]=0xe1;		//north
			LUXmap[fynlin+toSouth]=0xb4;	//south
			LUXmap[d*wp1]=0x1b;	//NW
			LUXmap[(d+1)*wm1]=0x1b;	//SW
			var fill_len=staidx-d;
			for(var kk=0;kk<fill_len;kk++)
			{
				var kk1d=kk+1+d;
				LUXmap[kk1d*LUXmap_width+d]=0xd8;	//NW-n
				LUXmap[d*LUXmap_width+kk1d]=0xb1;	//NW-w
				LUXmap[d*LUXmap_width+staidx+2+kk]=0x4e;	//SW-w
				LUXmap[kk1d*LUXmap_width+wm1-d]=0x27;	//SW-s
			}
			LUXmap[gibidx]=0x72;
			gibidx+=wm1;
		}
		
		
	}

	cur_lx_size=n;
}

/*

function buildlx_bad(n)
{
	if(LUXmap[n]){return LUXmap[n];}
	var qoddn=n>>2;
	var oddn=n>>1;
	var nx2=n<<1;
	var ret=new Uint8Array(nx2*(1+qoddn));
	var staidx=qoddn-1;
	var lyn0=staidx*(oddn+1)*4;
	ret.set(LUXele[0], lyn0);
	lyn0+=nx2;
	ret.set(LUXele[1], lyn0);
	lyn0-=staidx*4;
	var toSouth=12+staidx*4;
	if(staidx>0)
	{

		for(var d=0;d<staidx;d++)
		{
			ret.set(LUXele[4],(d*oddn+qoddn)<<2);	//west
			var fynlin=lyn0+(d<<2);
			ret.set(LUXele[2],fynlin);	//north
			
			ret.set(LUXele[3],fynlin+toSouth);	//south
			ret.set(LUXele[5],d*4*(oddn+1));	//NW
			ret.set(LUXele[5],(d+1)*(oddn-1)*4);	//SW
			var fill_len=staidx-d;
			for(var kk=0;kk<fill_len;kk++)
			{
				var kk1d=kk+1+d;
				ret.set(LUXele[6],(kk1d*oddn+d)*4);	//NW-n
				ret.set(LUXele[5],(d*oddn+kk1d)*4);	//NW-w
				ret.set(LUXele[7],(d*oddn+staidx+2+kk)*4);	//SW-w
				ret.set(LUXele[8],(kk1d*oddn+oddn-1-d)*4);//SW-s
			}
			

		}

	}
	

	LUXmap[n]=ret;
	return ret;
}

function testlx_bad(n)
{
	var oddn=n>>1;
	var nx2=n<<1;
	var qoddnp1=(n>>2)+1;
	var src=LUXmap[n];

	var ret=[];
	for(var y=0;y<oddn;y++)
	{
		var y0a=y<<2;
		var tuoline=[new Array(qoddnp1),new Array(qoddnp1)];
		for(var x=0;x<qoddnp1;x++)
		{
			var staidx=x*nx2+y0a;
			tuoline[0][x]=src[staidx]+' '+src[staidx+1];
			tuoline[1][x]=src[staidx+2]+' '+src[staidx+3];
		}
		ret.push(tuoline[0].join(ztab)+'\n'+tuoline[1].join(ztab));
		ret.push('');
	}
	return ret.join('\n');

}
*/

function odd_clamp4bit(allrg,sft=1)
{
	allrg<<=sft;
	if(allrg<257){return [4,new Uint8Array(allrg)];}
	else if(allrg<65537){return [8,new Uint16Array(allrg)];}
	return [16,new Uint32Array(allrg)];
}



function cbnxcha(v1,v2)
{
	var xc1=xcha[v1];
	var xc2=xcha[v2];
	if(v1==1){return xc2;}
	else if(v2==1){return xc1;}
	var rzwh=v1*v2;
	var rz=odd_clamp4bit(rzwh*rzwh);
	
	for(var y0=0;y0<v1;y0++)
	{
		var y0a=y0*v1;
		var y0abg=y0*v2;
		for(var x0=y0;x0<v1;x0++)
		{
			var x0abg=x0*v2;
			var jidi=xc1[y0a+x0]*v2;
			for(var y1=0;y1<v2;y1++)
			{
				var y1a=y1*v2;
				for(var x1=y1;x1<v2;x1++)
				{
					var cvv=xc2[y1a+x1]+jidi;
					rz[(y0abg+y1)*rzwh+(x0abg+x1)]=cvv;
					rz[(x0abg+x1)*rzwh+(y0abg+y1)]=cvv;
					rz[(y0abg+x1)*rzwh+(x0abg+y1)]=cvv;
					rz[(x0abg+y1)*rzwh+(y0abg+x1)]=cvv;
				}
			}
		}
	}
	xcha[rzwh]=rz;
	return rz;

}

function odd_xorchart(oddn,xortyp=-1)
{

	print_moddiv=oddn;
	var allrg=oddn*oddn;
	if(xortyp>0){oddn=xortyp;}
	cur_moddiv=oddn;
	var ret=setupdgtsft(odd_clamp4bit(allrg));

	var slb=oddn-3;
	var ksta=3;
	var revksta=slb;
	var rvallrg=allrg-1;
	var lztmod=oddn-1;


	if(!xcha[oddn]){
	cur_xormap=ret.subarray(0,allrg);
	ret=ret.subarray(allrg,allrg<<1);
	
	for(var d=0;d<oddn;d++)
	{
		cur_xormap[d]=d;
		cur_xormap[d*oddn]=d;
		cur_xormap[(d+1)*lztmod]=lztmod;
	}
	
	cur_xormap[rvallrg]=1;
	for(var dkr=1;dkr<slb;dkr++)
	{
		
		var dy=oddn;
		for(var dx=dkr;dx>=1;dx--)
		{
			var ydx=dy+dx;
			cur_xormap[ydx]=ksta;
			cur_xormap[rvallrg-ydx]=revksta;
			dy+=oddn;
		}
		ksta++;
		revksta--;
	}
	
	slb=oddn+2*lztmod;
	rvallrg=oddn+lztmod;
	ksta=lztmod*oddn-1;
	for(var d=2;d<lztmod;d++)
	{
		cur_xormap[slb]=1;
		cur_xormap[rvallrg]=d;
		cur_xormap[ksta+d]=d;
		slb+=lztmod;
		rvallrg+=oddn;
	}
		xcha[oddn]=cur_xormap;
	} else {
		cur_xormap=xcha[oddn];
		ret=ret.subarray(allrg,allrg<<1);}
	
	ret[0]=0;
	slb=oddn>>1;
	ret[slb]=(lztmod<<dgtsft)|(slb-1);
	slb-=1;
	rvallrg=slb;
	ksta=2;
	revksta=3;
	var nxidx=slb+(oddn>>1);
	var nxvv=oddn-3;
	var ydridx=oddn*slb+lztmod-1;
	ret[lztmod]=(1<<dgtsft)|(nxvv+1);
	for(var d=0;d<slb;d++)
	{
		ret[rvallrg]=ksta<<dgtsft|cur_xormap[ydridx];
		ret[nxidx]=(revksta<<dgtsft)|nxvv;
		rvallrg--;
		nxidx--;
		nxvv--;
		ksta+=2;
		revksta+=2;
		ydridx-=oddn;
	}
	


	return ret;

}

function MyXor_odd(v1,v2)
{
	var v1upr=(v1>>dgtsft)&bmsk;
	var v1dwn=v1&bmsk;
	var v2upr=(v2>>dgtsft)&bmsk;
	var v2dwn=v2&bmsk;
	var rzupr=0;
	var rzdwn=0;
	var gzz=1;
	for(var i=0;i<32;i++)
	{
		if((v1upr+v1dwn+v2upr+v2dwn)==0){break;}

		var v1uprVu=v1upr%cur_moddiv;
		var v1dwnVu=v1dwn%cur_moddiv;
		var v2uprVu=v2upr%cur_moddiv;
		var v2dwnVu=v2dwn%cur_moddiv;

		rzupr+=cur_xormap[(v1uprVu*cur_moddiv)+v2uprVu]*gzz;
		rzdwn+=cur_xormap[(v1dwnVu*cur_moddiv)+v2dwnVu]*gzz;


		v1upr=((v1upr-v1uprVu)/cur_moddiv)>>0;
		v1dwn=((v1dwn-v1dwnVu)/cur_moddiv)>>0;
		v2upr=((v2upr-v2uprVu)/cur_moddiv)>>0;
		v2dwn=((v2dwn-v2dwnVu)/cur_moddiv)>>0;
		gzz*=cur_moddiv;
	}
	return (rzupr<<dgtsft)|rzdwn;
}

function strliz_odd2dgt0(cvv)
{
	return ((cvv>>dgtsft)&bmsk)*print_moddiv+(cvv&bmsk);
}

function printencmgsq()
{
	var wh=Math.sqrt(mgsq_encoded.length)<<0;
	if((wh&1)==1)
	{
		var ret=new Array(wh);
		for(var y=0;y<wh;y++)
		{
			var y0a=y*wh;
			var rowz=new Array(wh);
			for(var x=0;x<wh;x++)
			{
				rowz[x]=mgsq_encoded[y0a+x].toString(16);
			}
			ret[y]=rowz.join(' ');
		}
		return ret.join('\n');
	} else if ((wh&3)==2) {
		var ret=[];
		var divby2=wh>>1;
		for(var y=0;y<divby2;y++)
		{
			var y0b=y<<1;
			for(var y1=0;y1<2;y1++)
			{
				var y0n=y0b+y1;
				var y0a=y0n*wh;
				var rowz=new Array(divby2);
				for(var x=0;x<divby2;x++)
				{
					var x0b=x<<1;
					var ydx=y0a+x0b;
					rowz[x]=mgsq_encoded[ydx].toString(16)+' '+mgsq_encoded[ydx+1].toString(16);
				}
				ret.push(rowz.join(ztab));
			}
			ret.push('');
		}
		return ret.join('\n');
	} 


}

var strliz_odd2dgt=strliz_odd2dgt0;
function printmgsq_odd2dgt(src)
{
	mgsq_decoded=odd_clamp4bit(print_moddiv*print_moddiv,0);
	mgsq_decoded=mgsq_decoded[1];
	var ret=new Array(print_moddiv);
	var cols_calc=new Array(print_moddiv);
	var rows_calc=new Array(print_moddiv);
	cols_calc.fill(0);
	rows_calc.fill(0);

	for(var y=0;y<print_moddiv;y++)
	{
		var y0a=y*print_moddiv;
		var rowz=new Array(print_moddiv);
		for(var x=0;x<print_moddiv;x++)
		{
			
			var ydx=y0a+x;
			var cvv=strliz_odd2dgt(src[ydx]);
			cols_calc[x]+=cvv;
			rows_calc[y]+=cvv;
			mgsq_decoded[ydx]=cvv;
			rowz[x]=strliz(cvv);
		}
		ret[y]=rowz.join(' ');
	}
	mgsq_tested=[cols_calc,rows_calc];
	diagsum();
	return ret.join('\n');
}

function colrowsum(src,v)
{
	var cols_calc=new Array(v);
	var rows_calc=new Array(v);
	cols_calc.fill(0);
	rows_calc.fill(0);
	for(var y=0;y<v;y++)
	{
		var y0a=y*v;
		for(var x=0;x<v;x++)
		{
			var cvv=src[y0a+x];
			cols_calc[x]+=cvv;
			rows_calc[y]+=cvv;
		}
	}
	mgsq_tested=[cols_calc,rows_calc];
}

function diagsum(src=null,v=-1)
{
	
	if(v<0){v= print_moddiv;};
	var allrg=v*v;
	var laztm=allrg-1;
	var diaglazt=laztm;
	var rvdiaglazt=laztm-v+1;
	var diag=new Array(v);
	var rvdiag=new Array(v);
	diag.fill(0);
	rvdiag.fill(0);
	var diagsub=v+1;
	var rvdiagsub=v-1;
	if(!src){src=mgsq_decoded;}

	for(var dyr=0;dyr<v;dyr++)
	{
		var cur_diag=diaglazt;
		var cur_rvdiag=rvdiaglazt;
		for(var y=0;y<v;y++)
		{
			diag[dyr]+=src[cur_diag];
			rvdiag[dyr]+=src[cur_rvdiag];
			cur_diag-=diagsub;
			cur_rvdiag-=rvdiagsub;
			if(cur_diag<0){cur_diag+=allrg;}
			if(cur_rvdiag<0){cur_rvdiag+=allrg;}
		}
		diaglazt-=v;
		rvdiaglazt-=v;
	}
	mgsq_tested[2]=diag;
	mgsq_tested[3]=rvdiag;
	var gooddiag=diag[0];
	var diag_good=1;
	var rvdiag_good=1;
	for(var i=1;i<v;i++)
	{
		if(diag[i]==gooddiag){diag_good++;}
		if(rvdiag[i]==gooddiag){rvdiag_good++;}
	}
	mgsq_tested[4]=diag_good;
	mgsq_tested[5]=rvdiag_good;
}



function gf_odd_mad(ysle,xsle)
{
	var sql=ysle.length;
	var ret=ysle[0]&xsle[0];
	for(var d=1;d<sql;d++)
	{
		ret=MyXor_odd(ret,ysle[d]&xsle[d]);
	}
	return ret;

}

function matmul_odd(v1,v2,n,xortyp=-1)
{
	var kw=(v1.length/n)>>0;
	var ret = odd_xorchart(n,xortyp);
	for(var y=0;y<n;y++)
	{
		var ysle=new Array(kw);
		for(var d=0;d<kw;d++)
		{
			ysle[d]=v1[d*n+y];
		}
		for(var x=0;x<n;x++)
		{
			var xsle=new Array(kw);
			for(var d=0;d<kw;d++)
			{
				xsle[d]=v2[d*n+x];
			}
			ret[y*n+x]=gf_odd_mad(ysle,xsle);
		}
	}
	return printmgsq_odd2dgt(ret);
	
}

function extractfirstcolrow(src)
{
	var rows = new Array(print_moddiv*2);
	var cols = new Array(print_moddiv*2);
	rows.fill('ff');
	cols.fill('ff');
	for(var d=0;d<print_moddiv;d++)
	{
		rows[print_moddiv+d]=src[d].toString(16);
		cols[d]=src[print_moddiv*d].toString(16);
	}
	return '[0'+cols.join(',0x')+'],[0x'+rows.join(',0x')+']';

}

var extype=1;
var x3use=0;

function x3_xorchat(cot3,rz)
{
switch(x3use) {
	case 0:
		if(rz==1){rz=3; cot3--;}
		else{odd_xorchart(rz,-1);}
		cot3--;
		var bz3=3;
		for(var i=0;i<cot3;i++)
		{
			cbnxcha(bz3,3);
			bz3*=3;
		}
	return cbnxcha(bz3,rz);


	case 1:
		if(rz!=1){odd_xorchart(rz,-1);}
		var bz3=rz;
		var lzt=0;
		for(var i=0;i<cot3;i++)
		{
			lzt=cbnxcha(bz3,3);
			bz3*=3;
		}
	return lzt;
}


}

function mgsq3xFirstRow(n,buf)
{
	var qn=n>>2;
	var lztn=n-1;
	var lyn0=n*lztn;
	var midn=(n-1)>>1;	//9:	(n-1)>>1;	15:	n-((n-1)>>1);
	var lztq=n-1-qn;
	var upr3=[cur_xormap[lyn0+midn]<<dgtsft,cur_xormap[lyn0+qn]<<dgtsft,cur_xormap[lyn0+lztq]<<dgtsft];
	var skp3=(n/3)>>0;
	for(var i=0;i<skp3;i++)
	{
		buf[i*3]=upr3[0];
		buf[i*3+1]=upr3[1];
		buf[i*3+2]=upr3[2];
	}
	var lowrn=[0]*skp3;
	upr3=[midn,lztq,qn];
	var ydxpa=new Array(skp3);
	ydxpa[0]=lztn;
	var wlklen=((n-1)/(skp3-1))>>0;
	var wlkcur=0;
	for(var d=1;d<skp3;d++)
	{
		ydxpa[d]=wlkcur;
		wlkcur+=wlklen;
	}

	for(var y=0;y<3;y++)
	{
		var xmov=upr3[y];
		for(var x=0;x<skp3;x++)
		{
			buf[y*skp3+x]|=cur_xormap[xmov+ydxpa[x]*n];
		}
	}

}

function setupdgtsft(ret)
{
	dgtsft=ret[0];
	bmsk=(1<<dgtsft)-1;
	return ret[1];
}

function mkmgsq3x(n)
{
	var cot3=1;
	var tstn=n/3;
	for(var i=0;i<32;i++)
	{
		if(tstn%3!=0){break;}
		cot3++;
		tstn/=3;
	}
	cur_xormap = x3_xorchat(cot3,tstn);
	var allrg=n*n;
	var ret=setupdgtsft(odd_clamp4bit(allrg,0));
	mgsq3xFirstRow(n,ret);
	print_moddiv=n;
	cur_moddiv=n;
	for(var d=0;d<n;d++)
	{
		var xorbs=ret[d];
		if(xorbs!=0)
		{
			xorbs=((xorbs&bmsk)<<dgtsft)+((xorbs>>dgtsft)&bmsk);
			var mvbs=d*n;
			ret[mvbs]=xorbs;
			mvbs++;
			for(var x=1;x<n;x++)
			{
				ret[mvbs]=MyXor_odd(xorbs,ret[x]);
				mvbs++;
			}
		}

	}

	mgsq_encoded=ret;
	return printmgsq_odd2dgt(ret);

}

function mkmgsq_sigl(n,xortyp=-1,prebs=null)
{
	if((n%3)==0)
	{
		if(n==3){mgsq_decoded=[7,0,5,	2,4,6,	3,8,1]; return;}

		return mkmgsq3x(n);
	}

	var ret = odd_xorchart(n,xortyp);
	if(prebs){ret=prebs;}
	for(var d=0;d<n;d++)
	{
		var xorbs=ret[d];
		if(xorbs!=0)
		{
			xorbs=((xorbs&bmsk)<<dgtsft)+((xorbs>>dgtsft)&bmsk);
			var mvbs=d*n;
			ret[mvbs]=xorbs;
			mvbs++;
			for(var x=1;x<n;x++)
			{
				ret[mvbs]=MyXor_odd(xorbs,ret[x]);
				mvbs++;
			}
		}

	}
	mgsq_encoded=ret;
	switch(extype)
	{
		case 1:
		return printmgsq_odd2dgt(ret);
		case 2:
		return extractfirstcolrow(ret);
	}
	return ret;
	
	

}

function enc2dgt(v)
{
	var mody=v%print_moddiv;
	return (((v-mody)/print_moddiv)<<dgtsft)|mody;

}

function printmgsq_4Np2(src)
{

	function str_w_enc(idx,xpp)
	{
		var yydx=idx+xpp;
		var vv=src[yydx];
		cols_calc[x0b+xpp]+=vv;
		rows_calc[y0n]+=vv;
		mgsq_encoded[yydx]=enc2dgt(vv);
		return strliz(vv);
	}

	
	var ret=[];
	var cols_calc=new Array(print_moddiv);
	var rows_calc=new Array(print_moddiv);
	cols_calc.fill(0);
	rows_calc.fill(0);
	var divby2=print_moddiv>>1;
	for(var y=0;y<divby2;y++)
	{
		var y0b=y<<1;
		for(var y1=0;y1<2;y1++)
		{
			var y0n=y0b+y1;
			var y0a=y0n*print_moddiv;
			var rowz=new Array(divby2);
			for(var x=0;x<divby2;x++)
			{
				var x0b=x<<1;
				var ydx=y0a+x0b;
				rowz[x]=str_w_enc(ydx,0)+' '+str_w_enc(ydx,1);
			}
			ret.push(rowz.join(ztab));
		}
		ret.push('');
	}
	mgsq_tested=[cols_calc,rows_calc];
	diagsum(src);
	return ret.join('\n');
}

function mkmgsq_4Np2(n)
{
	var oddhfn=n>>1;
	buildlx(n);
	mkmgsq_sigl(oddhfn);
	oddbase=[mgsq_decoded,mgsq_encoded];
	
	var oddhf=mgsq_decoded;
	var mulp=n*n;
	var lztm=mulp-1;
	var lztn=n-1;
	var ret = odd_clamp4bit(mulp,0);
	mgsq_encoded=odd_clamp4bit(mulp,0);
	mgsq_encoded=mgsq_encoded[1];

	ret=setupdgtsft(ret);
	print_moddiv=n;

	mulp>>=2;
	var oddhfhfn=(oddhfn>>1);

	var lxstp=LUXmap_height-oddhfhfn-1;
	var n0x2=n<<1;

	for(var y=0;y<oddhfn;y++)
	{
		var y0a=y<<1;
		for(var x=0;x<oddhfhfn;x++)
		{
			var ady=oddhf[y*oddhfn+x];
			var x0a=x<<1;
			var lxv=LUXmap[(x+lxstp)*LUXmap_width+y+lxstp];
			for(var y1=0;y1<2;y1++) { for(var x1=0;x1<2;x1++) {
				var cur_y=y0a+y1;
				var cur_x=x0a+x1;
				var vlu=ady+ ((lxv>>((3-y1*2-x1)<<1))&3) *mulp;
				ret[cur_y*n+cur_x]=vlu;
				ret[(lztn-cur_y)*n+(lztn-cur_x)]=lztm-vlu;
			}}
		}
		var ady=oddhf[y*oddhfn+oddhfhfn];
		var lxv=LUXmap[(oddhfhfn+lxstp)*LUXmap_width+y+lxstp];
		var x0a=oddhfhfn<<1;
		for(var y1=0;y1<2;y1++) { for(var x1=0;x1<2;x1++) {
			ret[(y0a+y1)*n+(x0a+x1)]=ady+((lxv>>((3-y1*2-x1)<<1))&3)*mulp;
		}}
	}

	return printmgsq_4Np2(ret);

}

/*

printsq_deg45(xcha[9],2)

function printmgsq_odd2dgt_test1()
{
	dgtsft=4;
	bmsk=3;
	print_moddiv=3;
	printmgsq_odd2dgt([0x11,0,1,
		0,0,0,
		0,0,0]);
}

function mycbntst1()
{
	pbs=odd_xorchart(25);
	odd_xorchart(5);
	cbnxcha(5,5);
	strliz_odd2dgt=strliz1;
	return mkmgsq_sigl(25,-1,pbs);
}

*/


function gf2mad(ysle,xsle)
{
	var sql=ysle.length;
	var ret=ysle[0]&xsle[0];
	for(var d=1;d<sql;d++)
	{
		ret^=(ysle[d]&xsle[d]);
	}
	return ret;

}

function matmul(v1,v2,n=8)
{
	var kw=(v1.length/n)>>0;
	var ret =new Array(n*n);
	for(var y=0;y<n;y++)
	{
		var ysle=new Array(kw);
		for(var d=0;d<kw;d++)
		{
			ysle[d]=v1[d*n+y];
		}
		for(var x=0;x<n;x++)
		{
			var xsle=new Array(kw);
			for(var d=0;d<kw;d++)
			{
				xsle[d]=v2[d*n+x];
			}
			ret[y*n+x]=gf2mad(ysle,xsle);
		}
	}
	switch(extype)
	{
		case 1:
		colrowsum(ret,n);
		diagsum(ret,n);
		return printmgsq_by4(ret);
	}

	return ret;


}


var spelogic=new Array(16);

var hflv4logic_shi0map={
0:2,
221:2,
102:2,
187:2,

136:2,
51:1,
170:2,
17:1,

238:2,
85:1,
204:2,
119:1,

34:1,
153:1,
68:1,
255:1,
};

var hflv4logic_shi11map={
79:0,
11:0,
94:0,
26:0,

41:0,
109:0,
56:0,
124:0,
}

var hflv4logic_shi13map={
242:3,
208:3,
133:3,
167:3,

148:3,
182:3,
227:3,
193:3,
}

var hflv4logic_shi7map={
7:3,
143:3,
173:3,
37:3,

158:3,
22:3,
52:3,
188:3,
}

var hflv4logic_shi14map={
224:0,
241:0,
181:0,
164:0,

134:0,
151:0,
211:0,
194:0,
}

var hflv4logic_shi9map={
246:2,
178:2,
144:2,
212:2,
231:2,
163:2,
129:2,
197:2,
}

var hflv4logic_shi15map={
15:1,
45:1,
75:1,
105:1,

90:1,
60:1,
30:1,
120:1,	//???
}

var hflv4logic_shi6map={
219:2,	//11,3,10,2
83:2,	//=1???
202:2,
66:2,

232:1,	//8,0,9,14
96:1,
249:1,
113:1,
}

/*
0-3:
[24,3c]=every4,
[bd(d+-),7e]=every6

*/
function hflv4spelogic(v)
{
	var sinfo=hflv4shi[v]>>4;
	switch(sinfo)
	{
		case 0:
		var g0=1;
		if(v>128){g0=2;}
		return  [g0,3];

		case 6:	//せO, ず凹=2
		return [hflv4logic_shi6map[v],3];
	
		case 1:
		return [1,1];
		case 8:
		return [2,1];

		case 2:
		return [0,1];
		case 4:
		return [3,1];

		case 3:
		return [3,1];
		case 12:
		return [0,1];

	
		case 5:
		return [1,1];
		case 10:
		return [2,1];

		case 7:
		return [3,2];
		case 14:
		return [0,2];

		case 9:	//せ┎>128
		return  [2,2];

		case 15:	//|@<128
		return  [1,2];

		case 11:
		//var g0=0;	//<128
		//if(v>128){g0=3;}
		return  [0,2];

		case 13:
		//var g0=0;	//>128
		//if(v>128){g0=3;}
		return  [3,2];



	}
	

	return [-1,1];
}


var hflv3logic_shi3map={
3:0,
24:0,
10:0,
46:0,
}

var hflv3logic_shi6map={
48:2,
57:2,
43:2,
34:2,
}

function hflv3spelogic(v)
{
	var sinfo=hflv4shi[v]>>4;
	switch(sinfo)
	{
		
		case 1:
		case 4:
		return [1,1];

		case 3:
		return [0,1];
		case 6:
		return [2,1];

		case 0:
		case 2:
		return [1,3];

		case 5:	//possible0-2
		return [1,2];	//[0,2];
		case 7:
		return [1,2];	//[2,2];


	}
	return [-1,1];
}


function dummylogic(v)
{
	return [-1,1];
}

spelogic[2]=dummylogic;
spelogic[3]=hflv3spelogic;
spelogic[4]=hflv4spelogic;
spelogic[5]=dummylogic;

function mgsqtext()
{
	var hfrg=(1<<hflv);
	for(var y=0;y<hfrg;y++)
	{
		var y0a=y<<hflv;
		var yoff_bs=y*grpgap+2;
		for(var x=0;x<hfrg;x++)
		{
		var xoff=x*grpgap+2;
		var ydx=y0a+x;
		var v=mgsq[ydx];
		var fystr=v.toFixed(0);
		var zhu=fystr.length;
		for(var d=0;d<zhu;d++)
		{
			var rna=fystr.charCodeAt(d)-0x30;
			ctx.drawImage(numbs, rna*9, 0, 9, 9, xoff, yoff_bs+11*d, 9, 9);
		}
		}
	}
}

function fillgd012(gd,v,yoff,xoff,spefunc)
{
	var spe=spefunc(v);
	var spev=spe[0];
	var specolor=spe[1]*3;
	if(spev<0){spev=0;}

	

	for(var y=0;y<hflv;y++)
	{
		var y0a=grpgap*(yoff+y);
		for(var x=0;x<hflv;x++)
		{
			var ydx=y0a+(xoff+x)*4;
			gd[ydx]=specolor;
			gd[ydx+3]=0xff;
		}
	}

	var ybs=yoff+hflv-1;
	var ngspev=hflv-1-spev;
	var fixedv=(xoff+ngspev)*4;
	for(var i=0;i<hflv;i++)
	{
		var y0a=(ybs-i)*grpgap;
		var brush=v&1;
		if(i==spev)
		{
			for(var x=0;x<hflv;x++)
			{
				gd[ydx=y0a+(xoff+x)*4]=brush;
			}
		} else { gd[y0a+fixedv]=brush;}
		v>>=1;
	}


	var xbs=xoff+hflv-1;
	fixedv=grpgap*(yoff+ngspev);
	for(var i=0;i<hflv;i++)
	{
		var x0a=(xbs-i)*4;
		var brush=v&1;
		if(i==spev)
		{
			for(var y=0;y<hflv;y++)
			{
				gd[grpgap*(yoff+y)+x0a]+=brush;
			}
		} else { gd[fixedv+x0a]+=brush;}
		v>>=1;
	}

}

function map012()
{
	//mgsq=mkmgsq_even();
	setupshi1();

	var hfrg=(1<<hflv);
	var wh_each=hflv+2;
	var wh_canv=wh_each*hfrg;
	grpgap=wh_canv<<2;
	canv.width = wh_canv;
	canv.height = wh_canv;
	ctx.clearRect(0, 0, wh_canv, wh_canv);
	var imgd = ctx.getImageData(0, 0, wh_canv, wh_canv);
	var gd=imgd.data;
	for(var y=0;y<hfrg;y++)
	{
		var y0a=y<<hflv;
		var yoff=y*wh_each+1;
		for(var x=y;x<hfrg;x++)
		{
			var xoff=x*wh_each+1;
			var ydx=y0a+x;
			fillgd012(gd,mgsq[ydx],yoff,xoff,spelogic[hflv]);
		}
	}
	ctx.putImageData(imgd, 0, 0);

}

function map01()
{
	function drawcrox(ofst)
	{
		ctx.fillRect(ofst, 0, 1, canvwh);	//vert
		ctx.fillRect(0, ofst, canvwh, 1);
	}
	//mgsq=mkmgsq_even();
	setupshi1();
	var hfrg=(1<<hflv);
	grpgap=1+hflv*12;
	if(grpgap<37){grpgap=37;}
	var canvwhg=hfrg*grpgap
	var canvwh=canvwhg-1;

	

	canv.width = canvwhg;
	canv.height = canvwhg;
	ctx.clearRect(0, 0, canvwhg, canvwhg);
	ctx.fillStyle = 'blue';
	for(var i=1;i<hfrg;i++)
	{
		if((i&3)==0){ctx.fillStyle = 'red';}
		drawcrox(grpgap*i-1);
		ctx.fillStyle = 'blue';
		
	}
	
	mydofst=(hflv-2)*6;
	if(mydofst<10){mydofst=10;}
	for(var y=0;y<hfrg;y++)
	{
		var y0a=y<<hflv;
		var yoff=y*grpgap;
		for(var x=y;x<hfrg;x++)
		{
			var xoff=x*grpgap;
			var ydx=y0a+x;
			hfbin0and1(mgsq[ydx],xoff,yoff,spelogic[hflv]);	//yoff,xoff
		}

	}

}

function afterhflv()
{
	mgsq=mkmgsq_even();
	bmsk=(1<<hflv)-1;
	lvmax=(1<<lv)-1;
	is_hflvodd=((hflv&1) == 1);
}

afterhflv();

const mgsQ = {
	get test(){return mgsq_tested;},
	get enc() {return printencmgsq();},
	get dec() {return mgsq_decoded;},
	get lx() {return testlx();},
	get oddbs(){return oddbase;},
	set st(v){
		switch(v)
		{
			case 0:
			strliz=strliz0b;
			return;
			case 1:
			strliz=strliz0;
			return;
			case 2:
			strliz=strliz1;
			return;
		}
	},
	draw: function(n) {
		switch(n&3)
		{
			case 0:
			var level=is2n(n);
			if(level<0){var ret= mkmgsq_4x(n);
			} else{var ret= mkmgsq(level);n=int_sqrtf1(n);}
			switch(extype)
			{
				case 1:
				colrowsum(ret,n);
				diagsum(ret,n);
				return printmgsq_by4(ret);
			}
			return ret;
			case 2:
			return mkmgsq_4Np2(n);
			
		}
		return mkmgsq_sigl(n);
	return;}
}
const d = {
istile:false,
set lv(v){
	lv=v;
	hflv=lv>>1;
	afterhflv();},
set hflv(v){
	lv=v<<1;
	hflv=v;
	afterhflv();},
set d(v){draw(v);},
set dl(v){draw_linked(v);},
set rfn(v){refine();},
set rf2(v){refine2(v);},
set sqa(v){drawsqa(v);},
set shi(v){
	setupshi1();
	console.log(getshi(v));
	console.log(getshi(getrev(v)));
},
set sqalt(v){mkmgsq_even_alt();},
set txtsq(v){mgsqtext();},
set map(v){

if(v>1){map012();
} else {map01();}

},
};

</script></html>